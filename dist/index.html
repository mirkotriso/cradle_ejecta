<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body>
		<!-- <script src="./threejs/build/three.js"></script> -->
		<script type="module">

            import * as THREE from './threejs/build/three.module.js';
            import { OBJLoader } from './threejs/examples/jsm/loaders/OBJLoader.js';
            import { OrbitControls } from './threejs/examples/jsm/controls/OrbitControls.js';

            const bkgrndMaxRadius = 10;
            const clock = new THREE.Clock();

            // asteroid orbital period
            const Ta = 473.889287;  // days
            // reflectivity coefficient
            const Cr = 0.07;
            // asteroid mean radius
            const Ra = 440;  // m
            // asteroid gravitational parameter
            const mua = 32;  // m^3 / s^2
            // sun gravitational parameter
            const mus = 1.327 * 10**20;
            // 
            const P0 = 1.02 * 10**17;
            // area to mass ratio of the particle
            const m_a = 50;  // area to mass ratio
            // lightness parameter
            const beta = (1 + Cr) * P0 / (m_a * mua**(1/3) * mus**(2/3))
            // angular velocity of the asteroid orbit
            const omega = 2 * Math.PI / (Ta * 24 * 3600); 
            // normalisation constants
            const T = 1 / omega;
            const L = (mua / omega**2)**(1/3)
            const V = L / T;

            var state_0 = [0, 0, Ra, 0.02, 0, 0.3];

            function update(renderer, scene, camera, controls) {

                controls.update();

                var ryugu = scene.getObjectByName("ryugu", true);
                if (ryugu != undefined) {
                    ryugu.rotation.z += 1/2 * 0.01;
                }

                var par = scene.getObjectByName("particle", true);
                if (par != undefined) {

                    // euler method
                    let dh = clock.getDelta() * 500;
                    let dy = dynamics(state_0, beta);
                    dy = dy.map( function (x) { return x*dh; } );
                    let state_new = state_0.map( function(x, idx) { return x + dy[idx]; } )  ;

                    par.position.x = state_new[0] / Ra / 2;
                    par.position.y = state_new[1] / Ra / 2;
                    par.position.z = state_new[2] / Ra / 2;

                    state_0 = state_new;
                }

                renderer.render(scene, camera);
                requestAnimationFrame(function () {
                    update(renderer, scene, camera, controls);

                });
                }

            function init() {
                // Create the renderer that controls animation.
                let renderer = new THREE.WebGLRenderer({antialias: true});
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setClearColor("#121212", 1);
                // Attach the renderer to the div element.
                const container = document.createElement( 'div' );
                document.body.appendChild( container );
                container.appendChild( renderer.domElement );
                // Create the scene that holds all of the visible objects.
                let scene = new THREE.Scene();

                const camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 1000 );
                camera.position.set(5, 5, 0)
                scene.add( camera );

                const ambientLight = new THREE.AmbientLight( 0xcccccc, 0.6 );
                scene.add( ambientLight );

                const light = new THREE.PointLight( 0xffffff, 3, 15 );
                light.position.set( 4, 0, 0 );
                light.castShadow = true;
                scene.add( light );
                
                // Create controls that allows a user to move the scene with a mouse.
                let controls = new OrbitControls(camera, renderer.domElement);
                // controls.minDistance = 0.5;
                controls.minDistance = 0.2;
                controls.maxDistance = bkgrndMaxRadius;
                controls.update();

                // BACKGROUND
                addGalaxy(scene);

                createAsteroid(scene);

                createParticle(scene);

                window.addEventListener( 'resize', onWindowResize );

            // START ANIMATION
            update(renderer, scene, camera, controls);
            }

            /**
            * Resize window
            */
            function onWindowResize() {

                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();

                renderer.setSize( window.innerWidth, window.innerHeight );
            }

            // Texture Loader
            let textureLoader = new THREE.TextureLoader();
            let addGalaxy = function (scene) { 
            // Galaxy
            let galaxyGeometry = new THREE.SphereGeometry(bkgrndMaxRadius, 32, 32);
            let galaxyMaterial = new THREE.MeshBasicMaterial({
              side: THREE.BackSide
            });
            let galaxy = new THREE.Mesh(galaxyGeometry, galaxyMaterial);

            // Load Galaxy Textures
            textureLoader.crossOrigin = true;
            textureLoader.load(
                'https://s3-us-west-2.amazonaws.com/s.cdpn.io/141228/starfield.png',
                function(texture) {
                    galaxyMaterial.map = texture;
                    scene.add(galaxy);
                }
            );}

            let createAsteroid = function(scene) {
            // Create a material
            var textureLoader = new THREE.TextureLoader();
            var map = textureLoader.load('./img/stone_asteroid_tex.jpg');
            var material = new THREE.MeshStandardMaterial({
                map: map,
                flatShading: true,
                roughness: 0.8,
                metalness: 0.75
            });
            // instantiate a loader
            const loader = new OBJLoader();

            // load a resource
            loader.load(
                // resource URL
                './assets/model.obj',
                // called when resource is loaded
                function ( object ) {
                    object.name = 'ryugu';
                    object.castShadow = true;
                    object.receiveShadow = true;

                    // For any meshes in the model, add our material.
                    object.traverse( function ( node ) {
                        if ( node.isMesh ) node.material = material;
                    } );
                    scene.add( object );
                },
                // called when loading is in progresses
                function ( xhr ) {

                    console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );

                },
                // called when loading has errors
                function ( error ) {

                    console.log( 'An error happened' );

                }
            );
            }

            let createParticle = function(scene) {
                // Particle
                let particleGeometry = new THREE.SphereGeometry(0.05, 12, 12);
                let particleMaterial = new THREE.MeshBasicMaterial( {color: 0xffffff} );
                let particle = new THREE.Mesh(particleGeometry, particleMaterial);

                particle.position.set(0, 0, 0.5);
                particle.name = "particle";

                scene.add(particle);

            }

            let dynamics = function(states, beta) {

                let xdot, ydot, zdot, vxdot, vydot, vzdot;
                let r = Math.sqrt(states[0]**2 + states[1]**2 + states[2]**2);

                xdot = states[3];
                ydot = states[4];
                zdot = states[5];

                vxdot = - mua * states[0] / r**3;
                vydot = - mua * states[1] / r**3;
                vzdot = - mua * states[2] / r**3;

                return [xdot, ydot, zdot, vxdot, vydot, vzdot]
            }

            init();

		</script>
	</body>
</html>